# IoT Classter

IoT Classter is an unsupervised IoT device fingerprinting and classification system based on the network traffic flow through the gateway, which can be deployed at the entrance of a local network to measure and classify the IoT devices inside.

**This work is being reviewed by NOMS 2020.**

# How to start?

Before starting to fingerprint and classify IoT devices, the **pcap files** that may contain network traffic generated by IoT devices should be prepared.

## Step1. Prepare the pcap files

You can detect a single pcap file or several pcap files and put them into */data*. Then you need to obtain the pre-observation data with */preprocess/step1_pcap_preobservation*:

```shell
# change directory to /step1_pcap_preobservation

# build the tool, default path: ./bin/dataPreProcess
make
# usage: <program> <data path> <output path>
./bin/dataPreProcess ../../data ../../data
# remove or clean the built program
make clean
```

In addition, directory of data (*/data* in our demo) should contain: "iotList.csv", and this tool will output "ports.csv", "domain.csv" and "cipher_suite.csv" to the result path.

- **iotList.csv:** since the dataset we use has a known **IoT device list**, our traffic extractor can generate label according to the device list. When using pcap files contains unknown devices, you can provide a list of all the MAC addresses included to be compatible;
- **ports.csv, domain.csv, cipher_suite.csv**: pre-observation data of content and corresponding frequency.

## Step2. Create raw instances

To create raw instances, use tool in */traffic_extractor*:

```shell
# change directory to /traffic_extractor

# build the extractor, default path: ./bin/ext_tool
make
# usage: <program> <data path> <output path>
./bin/ext_tool ../data ../result
# remove or clean the built program
make clean
```

In addition, directory of data (*/data* in our demo) should contain: "iotList.csv", "ports.csv", "domain.csv" and "cipher_suite.csv". This tool will output: 

* **raw_data.csv**: since some instances are extracted from relatively small number of packets, we filter the instances according to total packet number, DNS packet number and NTP packet number. To rebuild features with other threshold of filter, raw data is stored;
* **bag_ports.csv, bag_domain.csv, bag_cipher_suite.csv**: origin bag features;
* **min_distribution.csv**: temporal features;
* **stage1_vec.csv, nw_feature**: spatial features;
* **info.csv**: detailed instance number statistic data.

## Step3. Preprocess of instances

To do the preprocess of our system, simply run the script in */preprocess/auto_preprocess.sh*:

```shell
# change directory to /preprocess
chmod +x ./auto_preprocess.sh
./auto_preprocess.sh
```

If you want to custom the path of data, edit the script according to the comment in it. If you use python 2, change *python3* in the script to *python*.

This will create a **instance.csv** in */result*.

## Step4. Train and validate the system

When the 72-dimensional instances are prepared, you can start to build the IoT Classter.

Our system is implemented in */IoT_Classter.ipynb*, which is a jupyter notebook file. Following the notebook you are able to train and validate the system. We highly recommend you to use jupyter notebook to employ our system to observe plots and results, however we also provide a normal python file in */IoT_Classter.py* which outputs png pictures to directory and accuracy to command line:

```shell
# require numpy, pandas, sklearn, keras, matplotlib
# if you use python 2, change the command to "python"
python3 ./IoT_Classter.py
```

In addition, there is a pretrained VAE model weights file provided in */vae.h5*. 

# Advanced Usage

## Configuration of encoding method

You can custom the configuration file (name should specify to "dataAnalysis.conf") to control the data analysis tool, here is an example:

```
0,Data Type: 0 for IoT dataset, 1 for Tunet Background Flow
0,Mode:0 for Feature Vectors Statistic analysis, 1 for Raw Reconstruct
16,[STA]Top M of Ports
8,[STA]Top N of Domain
2,[STA]Top P of Cipher Suite
5,[RAW]Pck Number Filter
5,[RAW]DNS Pck Number Filter
0,[RAW]NTP Pck Number Filter
1,[RAW]IP filter for DNS(1 or 0)
1,[STO]1 for STA store with head, 0 for STA store without head
```

Feel free to try other [STA] parameters to change the dimensions of two-tuple features.

## Modify system parameters

At the top of */IoT_Classter.ipynb* or */IoT_Classter.py*, you can change system parameters, here is an example:

```python
# Ststem Parametres
np_seed = 1998         # random seed to control the result

# Control Flag, set to True or False
# NOTICE: If the structure of the network is changed, the pretrained weight can't be employed 
use_pretrain = True   # load pretrained model, need to have vae.h5
save_model = True     # save model
plt_model = False     # plot model description picture
save_predict = True   # save latent space output (with label)
use_callback = False  # employ Earlystopping and Checkpoint during training

l1_dim = 50           # VAE encoder latent layer dimension
l2_dim = 50           # VAE decoder latent layer dimension
vae_mean = 0.0        # VAE sampling normal distribution mean
vae_std = 0.3         # VAE sampling normal distribution std deviation
latent_dim = 3        # latent space dimension

hp_epoch = 10000      # train epoch
hp_batch_size = 512   # train batch size

# directory path that contains instance.csv
iot_data_dir = "./result/"
```

# Dataset

Our implementation is based on the pcap files provided by an open dataset, you can download the full dataset [here](https://iotanalytics.unsw.edu.au/iottraces).

# License

This project is licensed under the GPLv3 License.